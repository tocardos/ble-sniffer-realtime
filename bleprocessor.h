//
// Copyright 2020 Marco Cominelli
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//

#ifndef BLE_PROCESSOR
#define BLE_PROCESSOR

#define LE1M_SRATE 2
#define LE2M_SRATE 1

#include <vector>
#include <complex>

typedef std::complex<double> iqsamp_t;

const std::vector<double> usrp_tune_freqs = {2420e6, 2462e6};

// Allocate and de-allocate decoder data.
void init_decoder(size_t databuf_size);
void free_decoder();

void ble_processing(iqsamp_t* samplebuf, uint8_t* binbuf, size_t nsamps, size_t num_mboards);
void iq_processing(iqsamp_t* samplebuf, uint8_t* binbuf, size_t nsamps, size_t num_mboards);
void chan_processing(iqsamp_t* samplebuf, uint8_t* binbuf, size_t nsamps, size_t num_mboards);
//void old_proc(iqsamp_t* samplebuf, uint8_t* binbuf, size_t nsamps, size_t num_mboards);

// Useful auxiliary functions.
__host__ __device__ void swap_byte(uint8_t* data);
__host__ __device__ void swap_nbytes(uint8_t* data, size_t length);
__host__ __device__ void ble_dewhiten(uint8_t* data, uint32_t ble_channel, uint32_t length);
uint32_t freq2chan(uint32_t freq);

void offlineproc(void);

/* playing along with different filter length and poly_length
 i managed to get 52MHz sampling rate, increase in overflow, but still providing interesting results*/

/*
FIR filter designed with http://t-filter.appspot.com
sampling frequency: 40 MHz
0 Hz - 1.1 MHz: gain = 1, ripple < 5 dB
1.8 MHz - 20 MHz: gain = 0, attenuation = -40 dB
*/
#ifdef NOTHING
#define DECFACTOR 20
#define POLY_LEN 5
#define FILTER_TAP_NUM 81
static double filter_taps[FILTER_TAP_NUM] = {
    0.003989802934893269, 0.00116263219316108, 0.0011703374498432562,
    0.0010575602093139385, 0.0007904292201485264, 0.0003445822832488563,
    -0.0002912585172182479, -0.00112240569967483, -0.002149586684204096,
    -0.0033629943422702636, -0.0047376765392051915, -0.006234764567221647,
    -0.007804569055051714, -0.009387176269585316, -0.010911824889796546,
    -0.01229840649650942, -0.013461103961554147, -0.014311866387691807,
    -0.014763220530113879, -0.014731867554766416, -0.014143372660971522,
    -0.012936454876455132, -0.011066018535722264, -0.008505752416612545,
    -0.0052509708989958125, -0.00132093629137646, 0.003240262111946999,
    0.008364028825701473, 0.013958181063568975, 0.019908736331785467,
    0.026083156593932136, 0.032334757557726, 0.038507447619447605,
    0.04444061393143045, 0.049974562618593114, 0.0549564134512078,
    0.05924571381235369, 0.06271938833181666, 0.06527626590868955,
    0.06684117505481149, 0.06736798398456653, 0.06684117505481149,
    0.06527626590868955, 0.06271938833181666, 0.05924571381235369,
    0.0549564134512078, 0.049974562618593114, 0.04444061393143045,
    0.038507447619447605, 0.032334757557726, 0.026083156593932136,
    0.019908736331785467, 0.013958181063568975, 0.008364028825701473,
    0.003240262111946999, -0.00132093629137646, -0.0052509708989958125,
    -0.008505752416612545, -0.011066018535722264, -0.012936454876455132,
    -0.014143372660971522, -0.014731867554766416, -0.014763220530113879,
    -0.014311866387691807, -0.013461103961554147, -0.01229840649650942,
    -0.010911824889796546, -0.009387176269585316, -0.007804569055051714,
    -0.006234764567221647, -0.0047376765392051915, -0.0033629943422702636,
    -0.002149586684204096, -0.00112240569967483, -0.0002912585172182479,
    0.0003445822832488563, 0.0007904292201485264, 0.0010575602093139385,
    0.0011703374498432562, 0.00116263219316108, 0.003989802934893269
};
#endif 
/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 52000000 Hz

* 0 Hz - 1100000 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 2.9015676487143596 dB

* 1800000 Hz - 26000000 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -43.07763111858491 dB

*/
#define DECFACTOR 26
#define POLY_LEN 4
#define FILTER_TAP_NUM 104

static double filter_taps[FILTER_TAP_NUM] = {
  0.0038926273168002406,  0.0007727980857433023,  0.0007753067449834552,
  0.0007197158549724672,  0.0005980899491561669,  0.0004020510769894272,
  0.0001253234347105988,  -0.00023732630524782989,  -0.0006889961356903474,
  -0.0012304585026603762,  -0.001859277825297484,  -0.0025699250113877694,
  -0.0033539589188889395,  -0.00420003575340867,  -0.005093600368870446,
  -0.0060161601279882385,  -0.0069458855670065,  -0.007858096271609147,
  -0.008727343856320265,  -0.00952472709024262,  -0.010220504989275224,
  -0.01078066456219985,  -0.01117998927074734,  -0.011383812650380291,
  -0.01136588605911414,  -0.011099232946269376,  -0.010562093630278779,
  -0.009735277964482715,  -0.008604503691903935,  -0.007160897815374591,
  -0.005401836225903462,  -0.003330665344754313,  -0.0009569508313533858,
  0.001703165056188632,  0.004626705345239701,  0.007783886854441539,
  0.011139140427405953,  0.014651386791874842,  0.018275074719111672,
  0.02195919918221799,  0.025653122715937452,  0.02929250106675564,
  0.03283936178075642,  0.036218831234974276,  0.039383264226225095,
  0.04228345433728379,  0.04487067100471541,  0.047098488379348394,
  0.04892777448314668,  0.05032709433478548,  0.05127314726777768,
  0.0517501556056054,  0.0517501556056054,  0.05127314726777768,
  0.05032709433478548,  0.04892777448314668,  0.047098488379348394,
  0.04487067100471541,  0.04228345433728379,  0.039383264226225095,
  0.036218831234974276,  0.03283936178075642,  0.02929250106675564,
  0.025653122715937452,  0.02195919918221799,  0.018275074719111672,
  0.014651386791874842,  0.011139140427405953,  0.007783886854441539,
  0.004626705345239701,  0.001703165056188632,  -0.0009569508313533858,
  -0.003330665344754313,  -0.005401836225903462,  -0.007160897815374591,
  -0.008604503691903935,  -0.009735277964482715,  -0.010562093630278779,
  -0.011099232946269376,  -0.01136588605911414,  -0.011383812650380291,
  -0.01117998927074734,  -0.01078066456219985,  -0.010220504989275224,
  -0.00952472709024262,  -0.008727343856320265,  -0.007858096271609147,
  -0.0069458855670065,  -0.0060161601279882385,  -0.005093600368870446,
  -0.00420003575340867,  -0.0033539589188889395,  -0.0025699250113877694,
  -0.001859277825297484,  -0.0012304585026603762,  -0.0006889961356903474,
  -0.00023732630524782989,  0.0001253234347105988,  0.0004020510769894272,
  0.0005980899491561669,  0.0007197158549724672,  0.0007753067449834552,
  0.0007727980857433023,  0.0038926273168002406
};
#ifdef NOTHING
/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 44000000 Hz

* 0 Hz - 1100000 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 2.914657401697511 dB

* 1800000 Hz - 22000000 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -43.03925583881057 dB

*/
#define DECFACTOR 22
#define POLY_LEN 4
#define FILTER_TAP_NUM 88

static double filter_taps[FILTER_TAP_NUM] = {
  0.003970017140167217,  0.0008926906543630351,  0.0008677122048278401,
  0.0007402003949200522,  0.0004943592196942271,  0.00011690839624074681,
  -0.00040189113358513366,  -0.0010672638225831016,  -0.0018791006876164285,
  -0.0028305008412895113,  -0.003906875503209807,  -0.005086817604766973,
  -0.006342491526962593,  -0.007634465360582884,  -0.008922027355872582,
  -0.010152903455991178,  -0.011273125375491256,  -0.012224375562649036,
  -0.012946509329344836,  -0.013380092437725378,  -0.013468192899638543,
  -0.013158243835038464,  -0.012404596420918772,  -0.01117092866755754,
  -0.009429125172966747,  -0.00717554528641269,  -0.004392961748013079,
  -0.0011159352803958732,  0.002632582894256887,  0.006809713550464758,
  0.011352381635415708,  0.016183876906952402,  0.021217990458952445,
  0.02636012836809324,  0.03150739575937731,  0.03655085053566153,
  0.041381130027234286,  0.045892030462346474,  0.049975423121693695,
  0.053541079065743194,  0.05650179483528428,  0.05878793899298807,
  0.06034396058904426,  0.06113164435126659,  0.06113164435126659,
  0.06034396058904426,  0.05878793899298807,  0.05650179483528428,
  0.053541079065743194,  0.049975423121693695,  0.045892030462346474,
  0.041381130027234286,  0.03655085053566153,  0.03150739575937731,
  0.02636012836809324,  0.021217990458952445,  0.016183876906952402,
  0.011352381635415708,  0.006809713550464758,  0.002632582894256887,
  -0.0011159352803958732,  -0.004392961748013079,  -0.00717554528641269,
  -0.009429125172966747,  -0.01117092866755754,  -0.012404596420918772,
  -0.013158243835038464,  -0.013468192899638543,  -0.013380092437725378,
  -0.012946509329344836,  -0.012224375562649036,  -0.011273125375491256,
  -0.010152903455991178,  -0.008922027355872582,  -0.007634465360582884,
  -0.006342491526962593,  -0.005086817604766973,  -0.003906875503209807,
  -0.0028305008412895113,  -0.0018791006876164285,  -0.0010672638225831016,
  -0.00040189113358513366,  0.00011690839624074681,  0.0004943592196942271,
  0.0007402003949200522,  0.0008677122048278401,  0.0008926906543630351,
  0.003970017140167217
};
#endif
#ifdef NOTHING
// for 40MHz with shorter filter ( 79 taps )
// works with poly_len at 4 
// differences with original filter taps are not visible in the results
#define DECFACTOR 20
#define POLY_LEN 4
#define FILTER_TAP_NUM 79
static double filter_taps[FILTER_TAP_NUM] ={
    0.0040170302511798334,0.0007489232299452944,0.0006268047541904718,
0.0003497418386057423,-0.00010031834404635918,-0.0007361038874154729,
-0.0015650798551869818,-0.0025857312107333513,-0.0037851702549404134,
-0.005138167556654884,-0.006607204563494685,-0.008143064628280591,
-0.009685661979008027,-0.011165104580592333,-0.012503212467447927,
-0.013615748456213446,-0.014415464471659041,-0.014815828887827433,
-0.014735114496697345,-0.0141004801212549,-0.012851767377762831,
-0.010944877907779512,-0.008354697873918121,-0.005077541255524328,
-0.0011330083108652491,0.0034349300662424994,0.00855783447528737,
0.014143828534114666,0.02007976905558558,0.026234430746665722,
0.032462505766937454,0.03860921674141626,0.04451538292410528,
0.0500228105614814,0.05497986302287763,0.05924700644388297,
0.06270206066716005,0.06524485950416331,0.06680106165203871,
0.06732493901860476,0.06680106165203871,0.06524485950416331,
0.06270206066716005,0.05924700644388297,0.05497986302287763,
0.0500228105614814,0.04451538292410528,0.03860921674141626,
0.032462505766937454,0.026234430746665722,0.02007976905558558,
0.014143828534114666,0.00855783447528737,0.0034349300662424994,
-0.0011330083108652491,-0.005077541255524328,-0.008354697873918121,
-0.010944877907779512,-0.012851767377762831,-0.0141004801212549,
-0.014735114496697345,-0.014815828887827433,-0.014415464471659041,
-0.013615748456213446,-0.012503212467447927,-0.011165104580592333,
-0.009685661979008027,-0.008143064628280591,-0.006607204563494685,
-0.005138167556654884,-0.0037851702549404134,-0.0025857312107333513,
-0.0015650798551869818,-0.0007361038874154729,-0.00010031834404635918,
0.0003497418386057423,0.0006268047541904718,0.0007489232299452944,
0.0040170302511798334,
};
#endif
#ifdef NOTHING
// for 40MHz with shorter filter ( 65 taps )
// works with poly_len at 4
#define DECFACTOR 20
#define POLY_LEN 4
#define FILTER_TAP_NUM 65
static double filter_taps[FILTER_TAP_NUM] = {
    
-0.006112777985159825,-0.004152094965114605,-0.005384441967166372,
-0.006713350684131068,-0.008082338838409937,-0.009443009599141714,
-0.010726812243686785,-0.011856296861149324,-0.012751668455762682,
-0.013332558624673184,-0.013518958404639368,-0.013233988208711557,
-0.012408546354290163,-0.010986187276322133,-0.00892674753540141,
-0.006208539717366667,-0.00282994608362516,0.0011888668227168701,
0.00580429649909523,0.010948614374945119,0.016530995610517477,
0.022440229785979995,0.028548383113597614,0.0347146721646366,
0.040789372987291066,0.046618126522134644,0.05204701587647594,
0.05692832230455293,0.06112637944801497,0.06452285280373471,
0.06702107428193438,0.06854941996143019,0.0690638277195138,
0.06854941996143019,0.06702107428193438,0.06452285280373471,
0.06112637944801497,0.05692832230455293,0.05204701587647594,
0.046618126522134644,0.040789372987291066,0.0347146721646366,
0.028548383113597614,0.022440229785979995,0.016530995610517477,
0.010948614374945119,0.00580429649909523,0.0011888668227168701,
-0.00282994608362516,-0.006208539717366667,-0.00892674753540141,
-0.010986187276322133,-0.012408546354290163,-0.013233988208711557,
-0.013518958404639368,-0.013332558624673184,-0.012751668455762682,
-0.011856296861149324,-0.010726812243686785,-0.009443009599141714,
-0.008082338838409937,-0.006713350684131068,-0.005384441967166372,
-0.004152094965114605,-0.006112777985159825,

};

#endif

#ifdef NOTHING
// for 16MHz sample rate on a smaller nvidia gpu
#define DECFACTOR 8
#define POLY_LEN 5
#define FILTER_TAP_NUM 42

static double filter_taps[FILTER_TAP_NUM] = {
-0.0013814544175492643, 0.001267715970866078, 0.00364512349904664,
0.007248761046218953, 0.011327682521030067, 0.014669711788424326,
0.01580159510359728, 0.013410224939860134, 0.0068673387726390905,
-0.0033116310323605897, -0.015245274951660318, -0.02583260497500089,
-0.0313109829596897, -0.028138848525842336, -0.013993973887791323,
0.01138710082115841, 0.04578845190733166, 0.08468259493527101,
0.12200721446456224, 0.1513982946416284, 0.16758419436590508,
0.16758419436590508, 0.1513982946416284, 0.12200721446456224,
0.08468259493527101, 0.04578845190733166, 0.01138710082115841,
-0.013993973887791323, -0.028138848525842336, -0.0313109829596897,
-0.02583260497500089, -0.015245274951660318, -0.0033116310323605897,
0.0068673387726390905, 0.013410224939860134, 0.01580159510359728,
0.014669711788424326, 0.011327682521030067, 0.007248761046218953,
0.00364512349904664, 0.001267715970866078, -0.0013814544175492643
};
#endif
#endif //BLE_PROCESSOR
